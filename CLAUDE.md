# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Run Commands

### Backend (Spring Boot)
```bash
cd backend
./mvnw spring-boot:run        # Run the server (port 8080)
./mvnw test                   # Run all tests
./mvnw test -Dtest=TestClass  # Run a single test class
./mvnw clean package          # Build JAR
```

### Frontend (Vite + React)
```bash
cd frontend
npm install                   # Install dependencies
npm run dev                   # Dev server with hot reload
npm run build                 # Production build (runs tsc first)
npm run preview               # Preview production build
```

## Architecture Overview

This is a personal chess analytics application that processes PGN files from Chess.com and Lichess.

### Data Flow
1. **Upload**: User uploads PGN file → `AccountController` → `IngestionService`
2. **Async Processing**: `IngestionService.processFileAsync()` streams through PGN → `PgnParser` extracts games
3. **Storage**: Games saved to H2 database with duplicate detection via SHA-256 hash
4. **Polling**: Frontend polls job status endpoint until processing completes
5. **Analytics**: `AnalyticsService` queries games with filters, returns aggregated stats

### Key Backend Components
- **PgnParser** (`parser/PgnParser.java`): Streaming parser for memory-efficient processing of large PGN files (30k+ games). Parses headers line-by-line, categorizes time controls, determines player color/result based on username
- **IngestionService** (`service/IngestionService.java`): Manages async uploads with `@Async`. Creates `UploadJob` records for progress tracking, updates processed/duplicate counts in real-time
- **AnalyticsService**: Provides calendar heatmap data and win/loss/draw statistics with filtering by time control, color, and account

### Frontend Structure
- **App.tsx**: Main state management - tracks current account, active upload job, refresh triggers
- **api/client.ts**: API wrapper that handles account resolution internally (finds or creates account before upload)
- **Components**: `UploadForm` (platform/username/file input), `JobProgress` (polls job status), `StatsPanel`, `CalendarHeatmap`

### Database
- H2 file-based database at `data/chess.db` (created automatically)
- Console available at `http://localhost:8080/h2-console` when running
- Schema auto-generated by Hibernate (`ddl-auto=update`)

### Key Design Decisions
- Username matching is case-insensitive when parsing PGN to determine which games belong to the account
- Duplicate games detected by SHA-256 hash of: date + white + black + result + first 200 chars of moves
- Time control categorization: ultrabullet (<30s), bullet (<180s), blitz (<600s), rapid (<1800s), classical (≥1800s)
